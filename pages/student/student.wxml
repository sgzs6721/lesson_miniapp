<!--student.wxml-->
<view class="page">
  <!-- æœç´¢å’Œæ·»åŠ å­¦å‘˜ -->
  <view class="search-add-container">
    <view class="search-box">
      <input type="text" placeholder="æœç´¢å­¦å‘˜" bindinput="onSearch" value="{{searchKey}}" />
      <view class="search-icon">ğŸ”</view>
    </view>
    <button class="add-btn" bindtap="showAddStudent">æ·»åŠ </button>
  </view>

  <!-- å­¦å‘˜åˆ—è¡¨ -->
  <view class="student-list">
    <view wx:if="{{loading && studentList.length === 0}}" class="loading-tip">åŠ è½½ä¸­...</view>
    <view wx:elif="{{studentList.length === 0}}" class="empty-tip">æš‚æ— å­¦å‘˜</view>

    <view wx:for="{{studentList}}" wx:key="id" class="student-item">
      <view class="student-info" bindtap="showStudentDetail" data-id="{{item.id}}">
        <view class="student-detail">
          <view class="student-name">{{item.studentName}} <text class="student-gender">{{item.studentGender === 'MALE' ? 'ç”·' : 'å¥³'}}</text></view>
          <view class="student-meta">
            <text>{{item.studentAge}}å²</text>
            <text class="dot"> Â· </text>
            <text>{{item.studentPhone}}</text>
          </view>
          <view class="student-courses">
            <text>{{item.courses.length}}é—¨è¯¾ç¨‹</text>
            <text class="dot"> Â· </text>
            <text>{{item.campusName}}</text>
          </view>
        </view>
      </view>
      <view class="student-actions">
        <view class="action-btn edit" bindtap="editStudent" data-id="{{item.id}}">ç¼–è¾‘</view>
        <view class="action-btn delete" bindtap="deleteStudent" data-id="{{item.id}}">åˆ é™¤</view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view wx:if="{{loading && studentList.length > 0}}" class="loading-more">åŠ è½½ä¸­...</view>
    <view wx:elif="{{!hasMore && studentList.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
  </view>

  <!-- å‡ºå‹¤è®°å½•æ ‡ç­¾é¡µ -->
  <view class="tab-content" hidden="{{activeTab !== 'attendance'}}">
    <!-- ç­›é€‰æ¡ä»¶ -->
    <view class="filter-bar">
      <picker mode="date" fields="month" value="{{currentMonth}}" bindchange="onMonthChange">
        <view class="filter-item">
          <text>{{currentMonth || 'é€‰æ‹©æœˆä»½'}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
      <picker mode="selector" range="{{courseList}}" range-key="name" value="{{courseIndex}}" bindchange="onCourseChange">
        <view class="filter-item">
          <text>{{selectedCourse ? selectedCourse.name : 'é€‰æ‹©è¯¾ç¨‹'}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
      <picker mode="selector" range="{{['å…¨éƒ¨', 'å·²åˆ°', 'æœªåˆ°', 'è¯·å‡']}}" value="{{statusIndex}}" bindchange="onStatusChange">
        <view class="filter-item">
          <text>{{statusOptions[statusIndex]}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- å‡ºå‹¤è®°å½•åˆ—è¡¨ -->
    <scroll-view class="attendance-list" scroll-y>
      <view wx:if="{{attendanceList.length === 0}}" class="empty-tip">æš‚æ— å‡ºå‹¤è®°å½•</view>
      <view wx:for="{{attendanceList}}" wx:key="id" class="attendance-item">
        <view class="attendance-date">{{item.date}}</view>
        <view class="attendance-info">
          <view class="attendance-course">{{item.courseName}}</view>
          <view class="attendance-student">{{item.studentName}}</view>
          <view class="attendance-time">{{item.time}}</view>
        </view>
        <view class="attendance-status {{item.status}}">
          <text>{{item.status === 'checked' ? 'å·²åˆ°' : (item.status === 'absent' ? 'æœªåˆ°' : 'è¯·å‡')}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘å­¦å‘˜å¼¹çª— -->
  <view class="modal {{showStudentModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideStudentModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{editingStudent ? 'ç¼–è¾‘å­¦å‘˜' : 'æ·»åŠ å­¦å‘˜'}}</text>
        <view class="modal-close" bindtap="hideStudentModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">å§“å</text>
          <input type="text" placeholder="è¯·è¾“å…¥å­¦å‘˜å§“å" value="{{studentForm.name}}" bindinput="onStudentFormInput" data-field="name" />
        </view>
        <view class="form-item">
          <text class="label">æ€§åˆ«</text>
          <picker mode="selector" range="{{genderOptions}}" value="{{studentForm.genderIndex}}" bindchange="onGenderChange">
            <view class="picker">
              {{genderOptions[studentForm.genderIndex] || 'è¯·é€‰æ‹©æ€§åˆ«'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">å¹´é¾„</text>
          <input type="number" placeholder="è¯·è¾“å…¥å¹´é¾„" value="{{studentForm.age}}" bindinput="onStudentFormInput" data-field="age" />
        </view>
        <view class="form-item">
          <text class="label">æ‰‹æœºå·</text>
          <input type="number" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" value="{{studentForm.phone}}" bindinput="onStudentFormInput" data-field="phone" />
        </view>
        <view class="form-item">
          <text class="label">é€‰æ‹©è¯¾ç¨‹</text>
          <view class="picker" bindtap="showCourseSelector">
            {{studentForm.selectedCourses.length > 0 ? studentForm.selectedCourses.length + 'é—¨è¯¾ç¨‹å·²é€‰æ‹©' : 'è¯·é€‰æ‹©è¯¾ç¨‹'}}
          </view>
        </view>

        <!-- å·²é€‰è¯¾ç¨‹åˆ—è¡¨ -->
        <view wx:if="{{studentForm.selectedCourses.length > 0}}" class="selected-courses">
          <text class="label">å·²é€‰è¯¾ç¨‹</text>
          <view wx:for="{{studentForm.selectedCourses}}" wx:key="id" class="course-schedule-item">
            <view class="course-info">
              <view class="course-basic">
                <text class="course-name">{{item.name}} ({{item.typeName}})</text>
                <text class="enroll-date">æŠ¥åæ—¥æœŸï¼š{{item.enrollDate || 'æœªè®¾ç½®'}}</text>
                <text class="schedule-info">
                  {{item.fixedScheduleTimes && item.fixedScheduleTimes.length > 0 ? item.fixedScheduleTimes.length + 'ä¸ªæ—¶é—´æ®µ' : 'æ— æ’è¯¾æ—¶é—´'}}
                </text>
              </view>
              <view class="edit-btn" bindtap="showCourseDetailModal" data-index="{{index}}">ç¼–è¾‘</view>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideStudentModal">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="saveStudent">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- è¯¾ç¨‹é€‰æ‹©å¼¹çª— -->
  <view class="modal {{showCourseSelector ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideCourseSelector"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>é€‰æ‹©è¯¾ç¨‹</text>
        <view class="modal-close" bindtap="hideCourseSelector">Ã—</view>
      </view>
      <view class="modal-body">
        <checkbox-group bindchange="onCourseChange">
          <view wx:for="{{courseList}}" wx:key="id" class="checkbox-item">
            <checkbox value="{{item.id}}" checked="{{item.checked}}"/>
            <text>{{item.name}} ({{item.typeName}})</text>
          </view>
        </checkbox-group>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideCourseSelector">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="hideCourseSelector">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- è¯¾ç¨‹è¯¦æƒ…ç¼–è¾‘å¼¹çª— -->
  <view class="modal {{showCourseDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideCourseDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>ç¼–è¾‘è¯¾ç¨‹ä¿¡æ¯</text>
        <view class="modal-close" bindtap="hideCourseDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view wx:if="{{editingCourseData}}" class="course-detail-form">
          <!-- è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ -->
          <view class="course-basic-info">
            <text class="course-title">{{editingCourseData.name}} ({{editingCourseData.typeName}})</text>
          </view>

          <!-- æŠ¥åæ—¥æœŸ -->
          <view class="form-item">
            <text class="label">æŠ¥åæ—¥æœŸ</text>
            <picker mode="date" value="{{editingCourseData.enrollDate}}" bindchange="onEnrollDateChange">
              <view class="picker">{{editingCourseData.enrollDate || 'è¯·é€‰æ‹©æŠ¥åæ—¥æœŸ'}}</view>
            </picker>
          </view>

          <!-- æ’è¯¾æ—¶é—´ -->
          <view class="form-item">
            <text class="label">å›ºå®šæ’è¯¾æ—¶é—´</text>
            <view class="schedule-times">
              <view wx:for="{{editingCourseData.fixedScheduleTimes}}" wx:key="index" class="schedule-time-item">
                <view class="schedule-time-row">
                  <picker mode="selector" range="{{weekdayOptions}}" value="{{item.weekday - 1}}" bindchange="onScheduleTimeChange" data-field="weekday" data-time-index="{{index}}">
                    <view class="schedule-picker">{{weekdayOptions[item.weekday - 1]}}</view>
                  </picker>
                  <picker mode="time" value="{{item.from}}" bindchange="onScheduleTimeChange" data-field="from" data-time-index="{{index}}">
                    <view class="schedule-picker">{{item.from}}</view>
                  </picker>
                  <text class="time-separator">-</text>
                  <picker mode="time" value="{{item.to}}" bindchange="onScheduleTimeChange" data-field="to" data-time-index="{{index}}">
                    <view class="schedule-picker">{{item.to}}</view>
                  </picker>
                  <view class="remove-btn" bindtap="removeScheduleTime" data-index="{{index}}">åˆ é™¤</view>
                </view>
              </view>
              <view class="add-schedule-btn" bindtap="addScheduleTime">+ æ·»åŠ æ—¶é—´æ®µ</view>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideCourseDetailModal">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="saveCourseDetail">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- å­¦å‘˜è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>å­¦å‘˜è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-item">
          <text class="label">å§“åï¼š</text>
          <text class="value">{{currentStudent.studentName}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ€§åˆ«ï¼š</text>
          <text class="value">{{currentStudent.studentGender === 'MALE' ? 'ç”·' : 'å¥³'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å¹´é¾„ï¼š</text>
          <text class="value">{{currentStudent.studentAge}}å²</text>
        </view>
        <view class="detail-item">
          <text class="label">æ‰‹æœºå·ï¼š</text>
          <text class="value">{{currentStudent.studentPhone}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ ¡åŒºï¼š</text>
          <text class="value">{{currentStudent.campusName}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æŠ¥åè¯¾ç¨‹ï¼š</text>
          <view class="value">
            <view wx:for="{{currentStudent.courses}}" wx:key="studentCourseId" class="course-detail-item" bindtap="showCourseInfoModal" data-course-index="{{index}}">
              <view class="course-basic-info">
                <text>{{item.courseName}} ({{item.courseTypeName}})</text>
                <text class="course-status">
                  {{item.status === 'studying' ? 'å­¦ä¹ ä¸­' :
                    (item.status === 'waiting_payment' ? 'ä»£ç¼´è´¹' :
                     (item.status === 'waiting_class' ? 'å¾…ä¸Šè¯¾' :
                      (item.status === 'COMPLETED' ? 'å·²å®Œæˆ' :
                       (item.status === 'SUSPENDED' ? 'å·²æš‚åœ' : item.status))))}}
                </text>
              </view>
              <view wx:if="{{item.enrollmentDate}}" class="course-enroll-date">
                <text class="enroll-label">æŠ¥åæ—¥æœŸï¼š</text>
                <text>{{item.enrollmentDate}}</text>
              </view>
              <view wx:if="{{item.fixedSchedule && item.fixedSchedule.length > 0}}" class="course-schedule">
                <text class="schedule-label">æ’è¯¾æ—¶é—´ï¼š</text>
                <text wx:for="{{item.fixedSchedule}}" wx:key="index" wx:for-item="schedule" class="schedule-time">
                  {{weekdayOptions[schedule.weekday - 1]}} {{schedule.from}}-{{schedule.to}}{{index < item.fixedSchedule.length - 1 ? 'ï¼Œ' : ''}}
                </text>
              </view>
              <view class="course-detail-arrow">></view>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn confirm" bindtap="hideDetailModal">å…³é—­</button>
      </view>
    </view>
  </view>

  <!-- è¯¾ç¨‹è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showCourseInfoModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideCourseInfoModal"></view>
    <view class="modal-content course-info-modal">
      <view class="modal-header">
        <text>è¯¾ç¨‹è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideCourseInfoModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view wx:if="{{currentCourseInfo}}" class="course-info-detail">
          <!-- è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ -->
          <view class="course-info-section">
            <view class="course-info-title">{{currentCourseInfo.courseName}}</view>
            <view class="course-info-subtitle">{{currentCourseInfo.courseTypeName}}</view>
            <view class="course-status-badge status-{{currentCourseInfo.status}}">
              {{currentCourseInfo.status === 'studying' ? 'å­¦ä¹ ä¸­' :
                (currentCourseInfo.status === 'waiting_payment' ? 'ä»£ç¼´è´¹' :
                 (currentCourseInfo.status === 'waiting_class' ? 'å¾…ä¸Šè¯¾' :
                  (currentCourseInfo.status === 'COMPLETED' ? 'å·²å®Œæˆ' :
                   (currentCourseInfo.status === 'SUSPENDED' ? 'å·²æš‚åœ' : currentCourseInfo.status))))}}
            </view>
          </view>

          <!-- è¯¾ç¨‹è¯¦ç»†ä¿¡æ¯ -->
          <view class="course-info-details">
            <view class="info-row">
              <text class="info-label">æ•™ç»ƒï¼š</text>
              <text class="info-value">{{currentCourseInfo.coachName || 'æœªåˆ†é…'}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æ€»è¯¾æ—¶ï¼š</text>
              <text class="info-value">{{currentCourseInfo.totalHours || 0}}å°æ—¶</text>
            </view>
            <view class="info-row">
              <text class="info-label">å‰©ä½™è¯¾æ—¶ï¼š</text>
              <text class="info-value">{{currentCourseInfo.remainingHours || 0}}å°æ—¶</text>
            </view>
            <view class="info-row">
              <text class="info-label">æŠ¥åæ—¥æœŸï¼š</text>
              <text class="info-value">{{currentCourseInfo.enrollmentDate || 'æœªè®¾ç½®'}}</text>
            </view>
            <view wx:if="{{currentCourseInfo.fixedSchedule && currentCourseInfo.fixedSchedule.length > 0}}" class="info-row">
              <text class="info-label">æ’è¯¾æ—¶é—´ï¼š</text>
              <view class="info-value">
                <text wx:for="{{currentCourseInfo.fixedSchedule}}" wx:key="index" wx:for-item="schedule" class="schedule-tag">
                  {{weekdayOptions[schedule.weekday - 1]}} {{schedule.from}}-{{schedule.to}}
                </text>
              </view>
            </view>
          </view>

        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® - ç§»åˆ°modal-bodyå¤–é¢ç¡®ä¿å§‹ç»ˆå¯è§ -->
      <view class="course-actions">
        <view class="action-row">
          <button class="action-btn primary" bindtap="showCourseRecords">è¯¾ç¨‹è®°å½•</button>
          <button class="action-btn primary" bindtap="showPaymentRecord">ç¼´è´¹ç™»è®°</button>
          <button class="action-btn secondary" bindtap="toggleMoreActions">
            æ›´å¤š {{showMoreActions ? 'â–²' : 'â–¼'}}
          </button>
        </view>

        <!-- æ›´å¤šæ“ä½œèœå• -->
        <view wx:if="{{showMoreActions}}" class="more-actions">
          <button class="more-action-btn" bindtap="withdrawCourse">é€€è¯¾</button>
          <button class="more-action-btn" bindtap="transferCourse">è½¬è¯¾</button>
          <button class="more-action-btn" bindtap="changeClass">è½¬ç­</button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç¼´è´¹è®°å½•å¼¹çª— -->
  <view class="modal {{showPaymentModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hidePaymentModal"></view>
    <view class="modal-content payment-modal">
      <view class="modal-header">
        <text>ç¼´è´¹ç™»è®°</text>
        <view class="modal-close" bindtap="hidePaymentModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view wx:if="{{currentCourseInfo}}" class="payment-form">
          <!-- è¯¾ç¨‹ä¿¡æ¯ -->
          <view class="course-info-header">
            <text class="course-name">{{currentCourseInfo.courseName}}</text>
            <text class="course-type">({{currentCourseInfo.courseTypeName}})</text>
          </view>

          <!-- ç¼´è´¹ä¿¡æ¯ -->
          <view class="form-section">
            <view class="section-title">ç¼´è´¹ä¿¡æ¯</view>

            <view class="form-item">
              <text class="label">ç¼´è´¹ç±»å‹</text>
              <picker mode="selector" range="{{paymentTypeOptions}}" value="{{paymentForm.paymentTypeIndex}}" bindchange="onPaymentTypeChange">
                <view class="picker">{{paymentTypeOptions[paymentForm.paymentTypeIndex]}}</view>
              </picker>
            </view>

            <view class="form-item">
              <text class="label">æ”¯ä»˜æ–¹å¼</text>
              <picker mode="selector" range="{{paymentMethodOptions}}" value="{{paymentForm.paymentMethodIndex}}" bindchange="onPaymentMethodChange">
                <view class="picker">{{paymentMethodOptions[paymentForm.paymentMethodIndex]}}</view>
              </picker>
            </view>

            <view class="form-item">
              <text class="label">ç¼´è´¹é‡‘é¢</text>
              <input type="digit" placeholder="è¯·è¾“å…¥ç¼´è´¹é‡‘é¢" value="{{paymentForm.amount}}" bindinput="onPaymentFormInput" data-field="amount" />
            </view>

            <view class="form-item">
              <text class="label">äº¤æ˜“æ—¥æœŸ</text>
              <picker mode="date" value="{{paymentForm.transactionDate}}" bindchange="onPaymentFormInput" data-field="transactionDate">
                <view class="picker">{{paymentForm.transactionDate || 'è¯·é€‰æ‹©äº¤æ˜“æ—¥æœŸ'}}</view>
              </picker>
            </view>
          </view>

          <!-- è¯¾æ—¶ä¿¡æ¯ -->
          <view class="form-section">
            <view class="section-title">è¯¾æ—¶ä¿¡æ¯</view>

            <view class="form-item">
              <text class="label">æ­£è¯¾è¯¾æ—¶</text>
              <input type="number" placeholder="è¯·è¾“å…¥æ­£è¯¾è¯¾æ—¶" value="{{paymentForm.courseHours}}" bindinput="onPaymentFormInput" data-field="courseHours" />
            </view>

            <view class="form-item">
              <text class="label">èµ é€è¯¾æ—¶</text>
              <input type="number" placeholder="è¯·è¾“å…¥èµ é€è¯¾æ—¶" value="{{paymentForm.giftHours}}" bindinput="onPaymentFormInput" data-field="giftHours" />
            </view>

            <view class="form-item">
              <text class="label">æœ‰æ•ˆæœŸè‡³</text>
              <picker mode="date" value="{{paymentForm.validUntil}}" bindchange="onPaymentFormInput" data-field="validUntil">
                <view class="picker">{{paymentForm.validUntil || 'è¯·é€‰æ‹©æœ‰æ•ˆæœŸ'}}</view>
              </picker>
            </view>
          </view>

          <!-- èµ å“ä¿¡æ¯ -->
          <view class="form-section">
            <view class="section-title">èµ å“ <text class="section-hint">(å¯å¤šé€‰)</text></view>
            <view class="gift-items">
              <checkbox-group wx:if="{{giftItemOptions.length > 0}}" bindchange="onGiftItemsChange">
                <view wx:for="{{giftItemOptions}}" wx:key="index" class="gift-item">
                  <checkbox value="{{giftItemValues[index]}}"/>
                  <text>{{item}}</text>
                </view>
              </checkbox-group>
              <text wx:else class="no-gifts">æš‚æ— èµ å“é€‰é¡¹</text>
            </view>
          </view>

          <!-- å¤‡æ³¨ä¿¡æ¯ -->
          <view class="form-section">
            <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
            <view class="form-item">
              <textarea placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" value="{{paymentForm.notes}}" bindinput="onPaymentFormInput" data-field="notes" />
            </view>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="payment-actions">
        <button class="btn cancel" bindtap="hidePaymentModal">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="submitPayment">æäº¤</button>
      </view>
    </view>
  </view>
</view>
