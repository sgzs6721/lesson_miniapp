<!--user.wxml-->
<view class="page">
  <view class="header">
    <view class="title">ç”¨æˆ·ç®¡ç†</view>
  </view>

  <!-- æœç´¢å’Œæ·»åŠ åŒºåŸŸ -->
  <view class="search-add-container">
    <view class="search-box">
      <input type="text" placeholder="æœç´¢ç”¨æˆ·" bindinput="onSearch" value="{{searchKey}}" />
      <view class="search-icon">ğŸ”</view>
    </view>
    <button class="add-btn" bindtap="showAddUser">æ·»åŠ </button>
  </view>

  <!-- ç”¨æˆ·åˆ—è¡¨ -->
  <scroll-view class="user-list" scroll-y>
    <view wx:if="{{userList.length === 0}}" class="empty-tip">æš‚æ— ç”¨æˆ·</view>
    <view wx:for="{{userList}}" wx:key="id" class="user-item">
      <view class="user-info" bindtap="showUserDetail" data-id="{{item.id}}">
        <image class="user-avatar" src="{{item.avatar || '/images/default-avatar.png'}}"></image>
        <view class="user-detail">
          <view class="user-name">{{item.name}} <text class="user-role">({{item.role}})</text></view>
          <view class="user-meta">
            <text>{{item.phone}}</text>
            <text class="dot">Â·</text>
            <text>{{item.campus}}</text>
          </view>
          <view class="user-status">
            <text class="status-tag {{item.status === 'active' ? 'active' : 'inactive'}}">{{item.status === 'active' ? 'æ­£å¸¸' : 'ç¦ç”¨'}}</text>
            <text class="last-login">æœ€è¿‘ç™»å½•: {{item.lastLogin || 'ä»æœªç™»å½•'}}</text>
          </view>
        </view>
      </view>
      <view class="user-actions">
        <view class="action-btn edit" catchtap="editUser" data-id="{{item.id}}">ç¼–è¾‘</view>
        <view class="action-btn delete" catchtap="deleteUser" data-id="{{item.id}}">åˆ é™¤</view>
      </view>
    </view>
  </scroll-view>

  <!-- æ·»åŠ /ç¼–è¾‘ç”¨æˆ·å¼¹çª— -->
  <view class="modal {{showUserModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideUserModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{editingUser ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ ç”¨æˆ·'}}</text>
        <view class="modal-close" bindtap="hideUserModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">ç”¨æˆ·å</text>
          <input type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="{{userForm.name}}" bindinput="onUserFormInput" data-field="name" />
        </view>
        <view class="form-item">
          <text class="label">è§’è‰²</text>
          <picker mode="selector" range="{{roleOptions}}" value="{{userForm.roleIndex}}" bindchange="onRoleChange">
            <view class="picker">
              {{userForm.role || 'è¯·é€‰æ‹©è§’è‰²'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">è”ç³»ç”µè¯</text>
          <input type="text" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" value="{{userForm.phone}}" bindinput="onUserFormInput" data-field="phone" />
        </view>
        <view class="form-item">
          <text class="label">æ‰€å±æ ¡åŒº</text>
          <picker mode="selector" range="{{campusList}}" range-key="name" value="{{userForm.campusIndex}}" bindchange="onCampusChange">
            <view class="picker">
              {{userForm.campus || 'è¯·é€‰æ‹©æ‰€å±æ ¡åŒº'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">è´¦å·çŠ¶æ€</text>
          <picker mode="selector" range="{{['æ­£å¸¸', 'ç¦ç”¨']}}" value="{{userForm.statusIndex}}" bindchange="onStatusChange">
            <view class="picker">
              {{userForm.status === 'active' ? 'æ­£å¸¸' : (userForm.status === 'inactive' ? 'ç¦ç”¨' : 'è¯·é€‰æ‹©çŠ¶æ€')}}
            </view>
          </picker>
        </view>
        <view class="form-item" wx:if="{{!editingUser}}">
          <text class="label">åˆå§‹å¯†ç </text>
          <input type="password" placeholder="è¯·è¾“å…¥åˆå§‹å¯†ç " value="{{userForm.password}}" bindinput="onUserFormInput" data-field="password" />
        </view>
        <view class="form-item">
          <text class="label">å¤‡æ³¨</text>
          <textarea placeholder="è¯·è¾“å…¥å¤‡æ³¨" value="{{userForm.remark}}" bindinput="onUserFormInput" data-field="remark" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideUserModal">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="saveUser">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>ç”¨æˆ·è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-item">
          <text class="label">ç”¨æˆ·å</text>
          <text class="value">{{currentUser.name}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è§’è‰²</text>
          <text class="value">{{currentUser.role}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è”ç³»ç”µè¯</text>
          <text class="value">{{currentUser.phone}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ‰€å±æ ¡åŒº</text>
          <text class="value">{{currentUser.campus}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è´¦å·çŠ¶æ€</text>
          <text class="value">{{currentUser.status === 'active' ? 'æ­£å¸¸' : 'ç¦ç”¨'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">åˆ›å»ºæ—¶é—´</text>
          <text class="value">{{currentUser.createTime || 'æœªçŸ¥'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æœ€è¿‘ç™»å½•</text>
          <text class="value">{{currentUser.lastLogin || 'ä»æœªç™»å½•'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å¤‡æ³¨</text>
          <text class="value">{{currentUser.remark || 'æ— '}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn confirm" bindtap="hideDetailModal">å…³é—­</button>
        <button wx:if="{{currentUser.status === 'active'}}" class="btn danger" catchtap="toggleUserStatus" data-id="{{currentUser.id}}">ç¦ç”¨è´¦å·</button>
        <button wx:else class="btn primary" catchtap="toggleUserStatus" data-id="{{currentUser.id}}">å¯ç”¨è´¦å·</button>
      </view>
    </view>
  </view>
</view> 