<!--user.wxml-->
<view class="page">
  <view class="header">
    <view class="title">ç”¨æˆ·ç®¡ç†</view>
  </view>

  <!-- æœç´¢å’Œæ·»åŠ åŒºåŸŸ -->
  <view class="search-add-container">
    <view class="search-box">
      <input type="text" placeholder="æœç´¢ç”¨æˆ·" bindinput="onSearch" value="{{searchKey}}" />
      <view class="search-icon">ğŸ”</view>
    </view>
    <button class="add-btn" bindtap="showAddUser">æ·»åŠ </button>
  </view>

  <!-- ç”¨æˆ·åˆ—è¡¨ -->
  <scroll-view class="user-list" scroll-y enable-back-to-top>
    <view wx:if="{{loading && userList.length === 0}}" class="loading-tip">åŠ è½½ä¸­...</view>
    <view wx:elif="{{!loading && userList.length === 0}}" class="empty-tip">æš‚æ— ç”¨æˆ·</view>
    <view wx:for="{{userList}}" wx:key="id" class="user-item">
      <view class="user-info" bindtap="showUserDetail" data-id="{{item.id}}">
        <view class="user-detail">
          <view class="user-name">{{item.realName}} <text class="user-role">({{item.role.name}})</text></view>
          <view class="user-meta">
            <text>{{item.phone}}</text>
            <text class="dot">{{item.campus.name ? 'Â·' : ''}}</text>
            <text>{{item.campus.name || ''}}</text>
          </view>
          <view class="user-status">
            <text class="status-tag {{item.status === 'ENABLED' ? 'active' : 'inactive'}}">{{item.status === 'ENABLED' ? 'å¯ç”¨' : 'ç¦ç”¨'}}</text>
            <text class="last-login">æœ€è¿‘ç™»å½•: {{item.lastLoginTime || 'ä»æœªç™»å½•'}}</text>
          </view>
        </view>
      </view>
      <view class="user-actions">
        <view class="action-btn edit" catchtap="editUser" data-id="{{item.id}}">ç¼–è¾‘</view>
        <view class="action-btn delete" catchtap="deleteUser" data-id="{{item.id}}">åˆ é™¤</view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view wx:if="{{loading && userList.length > 0}}" class="load-more-tip">åŠ è½½ä¸­...</view>
    <view wx:elif="{{!hasMore && userList.length > 0}}" class="load-more-tip">æ²¡æœ‰æ›´å¤šäº†</view>
  </scroll-view>

  <!-- æ·»åŠ /ç¼–è¾‘ç”¨æˆ·å¼¹çª— -->
  <view class="modal {{showUserModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideUserModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{editingUser ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ ç”¨æˆ·'}}</text>
        <view class="modal-close" bindtap="hideUserModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">çœŸå®å§“å</text>
          <input type="text" placeholder="è¯·è¾“å…¥çœŸå®å§“å" value="{{userForm.realName}}" bindinput="onUserFormInput" data-field="realName" />
        </view>
        <view class="form-item">
          <text class="label">æ‰‹æœºå·</text>
          <input type="number" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" value="{{userForm.phone}}" bindinput="onUserFormInput" data-field="phone" />
        </view>
        <view class="form-item">
          <text class="label">è§’è‰²</text>
          <picker mode="selector" range="{{roleOptions}}" range-key="label" value="{{userForm.roleIndex}}" bindchange="onRoleChange">
            <view class="picker">
              {{roleOptions[userForm.roleIndex].label || 'è¯·é€‰æ‹©è§’è‰²'}}
            </view>
          </picker>
        </view>
        <view class="form-item" wx:if="{{userForm.role === 'CAMPUS_ADMIN'}}">
          <text class="label">æ‰€å±æ ¡åŒº</text>
          <picker mode="selector" range="{{campusList}}" range-key="name" value="{{userForm.campusIndex}}" bindchange="onCampusChange">
            <view class="picker">
              {{campusList[userForm.campusIndex] ? campusList[userForm.campusIndex].name : 'è¯·é€‰æ‹©æ‰€å±æ ¡åŒº'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">è´¦å·çŠ¶æ€</text>
          <picker mode="selector" range="{{statusOptions}}" range-key="label" value="{{userForm.statusIndex}}" bindchange="onStatusChange">
            <view class="picker">
              {{statusOptions[userForm.statusIndex].label || 'è¯·é€‰æ‹©çŠ¶æ€'}}
            </view>
          </picker>
        </view>
        <view class="form-item" wx:if="{{!editingUser}}">
          <text class="label">åˆå§‹å¯†ç </text>
          <input type="password" placeholder="è¯·è¾“å…¥åˆå§‹å¯†ç " value="{{userForm.password}}" bindinput="onUserFormInput" data-field="password" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideUserModal">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="saveUser">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>ç”¨æˆ·è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-item">
          <text class="label">çœŸå®å§“å</text>
          <text class="value">{{currentUser.realName}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ‰‹æœºå·</text>
          <text class="value">{{currentUser.phone}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è§’è‰²</text>
          <text class="value">{{currentUser.role ? currentUser.role.name : 'æœªçŸ¥'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ‰€å±æ ¡åŒº</text>
          <text class="value">{{currentUser.campus ? currentUser.campus.name : 'å…¨éƒ¨æ ¡åŒº'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è´¦å·çŠ¶æ€</text>
          <text class="value">{{currentUser.status === 'ENABLED' ? 'å¯ç”¨' : 'ç¦ç”¨'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">åˆ›å»ºæ—¶é—´</text>
          <text class="value">{{currentUser.createdTime || 'æœªçŸ¥'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æœ€è¿‘ç™»å½•</text>
          <text class="value">{{currentUser.lastLoginTime || 'ä»æœªç™»å½•'}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn confirm" bindtap="hideDetailModal">å…³é—­</button>
      </view>
    </view>
  </view>
</view>
