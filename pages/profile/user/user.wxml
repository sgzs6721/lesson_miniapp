<!--user.wxml-->
<view class="page">
  <view class="header">
    <view class="title">用户管理</view>
  </view>

  <!-- 搜索和添加区域 -->
  <view class="search-add-container">
    <view class="search-box">
      <input type="text" placeholder="搜索用户" bindinput="onSearch" value="{{searchKey}}" />
      <view class="search-icon">🔍</view>
    </view>
    <button class="add-btn" bindtap="showAddUser">添加</button>
  </view>

  <!-- 用户列表 -->
  <scroll-view class="user-list" scroll-y enable-back-to-top>
    <view wx:if="{{loading && userList.length === 0}}" class="loading-tip">加载中...</view>
    <view wx:elif="{{!loading && userList.length === 0}}" class="empty-tip">暂无用户</view>
    <view wx:for="{{userList}}" wx:key="id" class="user-item">
      <view class="user-info" bindtap="showUserDetail" data-id="{{item.id}}">
        <view class="user-detail">
          <view class="user-name">{{item.realName}} <text class="user-role">({{item.role.name}})</text></view>
          <view class="user-meta">
            <text>{{item.phone}}</text>
            <text class="dot">{{item.campus.name ? '·' : ''}}</text>
            <text>{{item.campus.name || ''}}</text>
          </view>
          <view class="user-status">
            <text class="status-tag {{item.status === 'ENABLED' ? 'active' : 'inactive'}}">{{item.status === 'ENABLED' ? '启用' : '禁用'}}</text>
            <text class="last-login">最近登录: {{item.lastLoginTime || '从未登录'}}</text>
          </view>
        </view>
      </view>
      <view class="user-actions">
        <view class="action-btn edit" catchtap="editUser" data-id="{{item.id}}">编辑</view>
        <view class="action-btn delete" catchtap="deleteUser" data-id="{{item.id}}">删除</view>
      </view>
    </view>

    <!-- 加载更多提示 -->
    <view wx:if="{{loading && userList.length > 0}}" class="load-more-tip">加载中...</view>
    <view wx:elif="{{!hasMore && userList.length > 0}}" class="load-more-tip">没有更多了</view>
  </scroll-view>

  <!-- 添加/编辑用户弹窗 -->
  <view class="modal {{showUserModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideUserModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{editingUser ? '编辑用户' : '添加用户'}}</text>
        <view class="modal-close" bindtap="hideUserModal">×</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">真实姓名</text>
          <input type="text" placeholder="请输入真实姓名" value="{{userForm.realName}}" bindinput="onUserFormInput" data-field="realName" />
        </view>
        <view class="form-item">
          <text class="label">手机号</text>
          <input type="number" placeholder="请输入手机号" value="{{userForm.phone}}" bindinput="onUserFormInput" data-field="phone" />
        </view>
        <view class="form-item">
          <text class="label">角色</text>
          <picker mode="selector" range="{{roleOptions}}" range-key="label" value="{{userForm.roleIndex}}" bindchange="onRoleChange">
            <view class="picker">
              {{roleOptions[userForm.roleIndex].label || '请选择角色'}}
            </view>
          </picker>
        </view>
        <view class="form-item" wx:if="{{userForm.role === 'CAMPUS_ADMIN'}}">
          <text class="label">所属校区</text>
          <picker mode="selector" range="{{campusList}}" range-key="name" value="{{userForm.campusIndex}}" bindchange="onCampusChange">
            <view class="picker">
              {{campusList[userForm.campusIndex] ? campusList[userForm.campusIndex].name : '请选择所属校区'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">账号状态</text>
          <picker mode="selector" range="{{statusOptions}}" range-key="label" value="{{userForm.statusIndex}}" bindchange="onStatusChange">
            <view class="picker">
              {{statusOptions[userForm.statusIndex].label || '请选择状态'}}
            </view>
          </picker>
        </view>
        <view class="form-item" wx:if="{{!editingUser}}">
          <text class="label">初始密码</text>
          <input type="password" placeholder="请输入初始密码" value="{{userForm.password}}" bindinput="onUserFormInput" data-field="password" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideUserModal">取消</button>
        <button class="btn confirm" bindtap="saveUser">确定</button>
      </view>
    </view>
  </view>

  <!-- 用户详情弹窗 -->
  <view class="modal {{showDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>用户详情</text>
        <view class="modal-close" bindtap="hideDetailModal">×</view>
      </view>
      <view class="modal-body">
        <view class="detail-item">
          <text class="label">真实姓名</text>
          <text class="value">{{currentUser.realName}}</text>
        </view>
        <view class="detail-item">
          <text class="label">手机号</text>
          <text class="value">{{currentUser.phone}}</text>
        </view>
        <view class="detail-item">
          <text class="label">角色</text>
          <text class="value">{{currentUser.role ? currentUser.role.name : '未知'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">所属校区</text>
          <text class="value">{{currentUser.campus ? currentUser.campus.name : '全部校区'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">账号状态</text>
          <text class="value">{{currentUser.status === 'ENABLED' ? '启用' : '禁用'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">创建时间</text>
          <text class="value">{{currentUser.createdTime || '未知'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">最近登录</text>
          <text class="value">{{currentUser.lastLoginTime || '从未登录'}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn confirm" bindtap="hideDetailModal">关闭</button>
      </view>
    </view>
  </view>
</view>
