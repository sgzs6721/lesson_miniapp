<!--finance.wxml-->
<view class="page">
  <!-- é¡¶éƒ¨æ ‡ç­¾é¡µ -->
  <view class="tabs">
    <view class="tab {{activeTab === 'payment' ? 'active' : ''}}" bindtap="switchTab" data-tab="payment">ç¼´è´¹è®°å½•</view>
    <view class="tab {{activeTab === 'finance' ? 'active' : ''}}" bindtap="switchTab" data-tab="finance">æ”¶æ”¯ç®¡ç†</view>
  </view>

  <!-- ç¼´è´¹è®°å½•æ ‡ç­¾é¡µ -->
  <view class="tab-content" hidden="{{activeTab !== 'payment'}}">
    <!-- æœç´¢åŒºåŸŸ -->
    <view class="search-container">
      <view class="search-box">
        <input type="text" placeholder="æœç´¢å­¦å‘˜/è¯¾ç¨‹" bindinput="onPaymentSearch" value="{{paymentSearchKey}}" />
        <view class="search-icon">ğŸ”</view>
      </view>
    </view>

    <!-- ç­›é€‰æ¡ä»¶ -->
    <view class="filter-bar">
      <picker mode="date" fields="month" value="{{paymentMonth}}" bindchange="onPaymentMonthChange">
        <view class="filter-item">
          <text>{{paymentMonth || 'é€‰æ‹©æœˆä»½'}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
      <picker mode="selector" range="{{paymentTypeOptions}}" value="{{paymentTypeIndex}}" bindchange="onPaymentTypeChange">
        <view class="filter-item">
          <text>{{paymentTypeOptions[paymentTypeIndex]}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- ç¼´è´¹è®°å½•åˆ—è¡¨ -->
    <scroll-view class="payment-list" scroll-y>
      <view wx:if="{{paymentList.length === 0}}" class="empty-tip">æš‚æ— ç¼´è´¹è®°å½•</view>
      <view wx:for="{{paymentList}}" wx:key="id" class="payment-item" bindtap="showPaymentDetail" data-id="{{item.id}}">
        <view class="payment-info">
          <view class="payment-header">
            <view class="payment-student">{{item.studentName}}</view>
            <view class="payment-amount">Â¥{{item.amount}}</view>
          </view>
          <view class="payment-course">{{item.courseName}} ({{item.courseType}})</view>
          <view class="payment-meta">
            <text class="payment-date">{{item.date}}</text>
            <text class="dot">Â·</text>
            <text class="payment-hours">å¢åŠ {{item.hours}}è¯¾æ—¶</text>
            <text class="dot">Â·</text>
            <text class="payment-type">{{item.paymentType}}</text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ”¶æ”¯ç®¡ç†æ ‡ç­¾é¡µ -->
  <view class="tab-content" hidden="{{activeTab !== 'finance'}}">
    <!-- æœç´¢å’Œæ·»åŠ åŒºåŸŸ -->
    <view class="search-add-container">
      <view class="search-box">
        <input type="text" placeholder="æœç´¢é¡¹ç›®" bindinput="onFinanceSearch" value="{{financeSearchKey}}" />
        <view class="search-icon">ğŸ”</view>
      </view>
      <button class="add-btn" bindtap="showAddFinance">æ·»åŠ </button>
    </view>

    <!-- ç­›é€‰æ¡ä»¶ -->
    <view class="filter-bar">
      <picker mode="date" fields="month" value="{{financeMonth}}" bindchange="onFinanceMonthChange">
        <view class="filter-item">
          <text>{{financeMonth || 'é€‰æ‹©æœˆä»½'}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
      <picker mode="selector" range="{{['å…¨éƒ¨', 'æ”¶å…¥', 'æ”¯å‡º']}}" value="{{financeTypeIndex}}" bindchange="onFinanceTypeChange">
        <view class="filter-item">
          <text>{{['å…¨éƒ¨', 'æ”¶å…¥', 'æ”¯å‡º'][financeTypeIndex]}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- æ”¶æ”¯ç»Ÿè®¡ -->
    <view class="finance-summary">
      <view class="summary-item income">
        <view class="summary-label">æœ¬æœˆæ”¶å…¥</view>
        <view class="summary-value">Â¥{{monthlyIncome}}</view>
      </view>
      <view class="summary-item expense">
        <view class="summary-label">æœ¬æœˆæ”¯å‡º</view>
        <view class="summary-value">Â¥{{monthlyExpense}}</view>
      </view>
      <view class="summary-item balance">
        <view class="summary-label">æœ¬æœˆç»“ä½™</view>
        <view class="summary-value">Â¥{{monthlyBalance}}</view>
      </view>
    </view>

    <!-- æ”¶æ”¯è®°å½•åˆ—è¡¨ -->
    <scroll-view class="finance-list" scroll-y>
      <view wx:if="{{financeList.length === 0}}" class="empty-tip">æš‚æ— æ”¶æ”¯è®°å½•</view>
      <view wx:for="{{financeList}}" wx:key="id" class="finance-item">
        <view class="finance-info" bindtap="showFinanceDetail" data-id="{{item.id}}">
          <view class="finance-header">
            <view class="finance-project">{{item.project}}</view>
            <view class="finance-amount {{item.type === 'income' ? 'income' : 'expense'}}">
              {{item.type === 'income' ? '+' : '-'}}Â¥{{item.amount}}
            </view>
          </view>
          <view class="finance-meta">
            <text class="finance-date">{{item.date}}</text>
            <text class="dot">Â·</text>
            <text class="finance-category">{{item.category}}</text>
          </view>
          <view class="finance-remark" wx:if="{{item.remark}}">å¤‡æ³¨: {{item.remark}}</view>
        </view>
        <view class="finance-actions">
          <view class="action-btn edit" catchtap="editFinance" data-id="{{item.id}}">ç¼–è¾‘</view>
          <view class="action-btn delete" catchtap="deleteFinance" data-id="{{item.id}}">åˆ é™¤</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç¼´è´¹è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showPaymentDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hidePaymentDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>ç¼´è´¹è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hidePaymentDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-item">
          <text class="label">å­¦å‘˜å§“å</text>
          <text class="value">{{currentPayment.studentName}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è¯¾ç¨‹åç§°</text>
          <text class="value">{{currentPayment.courseName}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è¯¾ç¨‹ç±»å‹</text>
          <text class="value">{{currentPayment.courseType}}</text>
        </view>
        <view class="detail-item">
          <text class="label">ç¼´è´¹é‡‘é¢</text>
          <text class="value">Â¥{{currentPayment.amount}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å¢åŠ è¯¾æ—¶</text>
          <text class="value">{{currentPayment.hours}}è¯¾æ—¶</text>
        </view>
        <view class="detail-item">
          <text class="label">ç¼´è´¹ç±»å‹</text>
          <text class="value">{{currentPayment.paymentType}}</text>
        </view>
        <view class="detail-item">
          <text class="label">ç¼´è´¹æ—¥æœŸ</text>
          <text class="value">{{currentPayment.date}}</text>
        </view>
        <view class="detail-item">
          <text class="label">ç»åŠäºº</text>
          <text class="value">{{currentPayment.operator}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å¤‡æ³¨</text>
          <text class="value">{{currentPayment.remark || 'æ— '}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn confirm" bindtap="hidePaymentDetailModal">å…³é—­</button>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘æ”¶æ”¯å¼¹çª— -->
  <view class="modal {{showFinanceModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideFinanceModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{editingFinance ? 'ç¼–è¾‘æ”¶æ”¯' : 'æ·»åŠ æ”¶æ”¯'}}</text>
        <view class="modal-close" bindtap="hideFinanceModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">ç±»å‹</text>
          <picker mode="selector" range="{{['æ”¶å…¥', 'æ”¯å‡º']}}" value="{{financeForm.typeIndex}}" bindchange="onFinanceFormTypeChange">
            <view class="picker">
              {{financeForm.typeIndex === 0 ? 'æ”¶å…¥' : 'æ”¯å‡º'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">é¡¹ç›®</text>
          <input type="text" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" value="{{financeForm.project}}" bindinput="onFinanceFormInput" data-field="project" />
        </view>
        <view class="form-item">
          <text class="label">é‡‘é¢</text>
          <input type="digit" placeholder="è¯·è¾“å…¥é‡‘é¢" value="{{financeForm.amount}}" bindinput="onFinanceFormInput" data-field="amount" />
        </view>
        <view class="form-item">
          <text class="label">æ”¶æ”¯ç±»å‹</text>
          <input type="text" placeholder="è¯·è¾“å…¥æ”¶æ”¯ç±»å‹" value="{{financeForm.category}}" bindinput="onFinanceFormInput" data-field="category" />
        </view>
        <view class="form-item">
          <text class="label">æ—¥æœŸ</text>
          <picker mode="date" value="{{financeForm.date}}" bindchange="onFinanceFormDateChange">
            <view class="picker">
              {{financeForm.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">å¤‡æ³¨</text>
          <textarea placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" value="{{financeForm.remark}}" bindinput="onFinanceFormInput" data-field="remark" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideFinanceModal">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="saveFinance">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æ”¶æ”¯è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showFinanceDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideFinanceDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>æ”¶æ”¯è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideFinanceDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-item">
          <text class="label">ç±»å‹</text>
          <text class="value">{{currentFinance.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}}</text>
        </view>
        <view class="detail-item">
          <text class="label">é¡¹ç›®</text>
          <text class="value">{{currentFinance.project}}</text>
        </view>
        <view class="detail-item">
          <text class="label">é‡‘é¢</text>
          <text class="value">Â¥{{currentFinance.amount}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ”¶æ”¯ç±»å‹</text>
          <text class="value">{{currentFinance.category}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ—¥æœŸ</text>
          <text class="value">{{currentFinance.date}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å¤‡æ³¨</text>
          <text class="value">{{currentFinance.remark || 'æ— '}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn confirm" bindtap="hideFinanceDetailModal">å…³é—­</button>
      </view>
    </view>
  </view>
</view>
