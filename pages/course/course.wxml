<!--course.wxml-->
<view class="page">

  <!-- é¡¶éƒ¨æ ‡ç­¾é¡µ -->
  <view class="tabs">
    <view class="tab {{activeTab === 'course' ? 'active' : ''}}" bindtap="switchTab" data-tab="course">è¯¾ç¨‹åˆ—è¡¨</view>
    <view class="tab {{activeTab === 'schedule' ? 'active' : ''}}" bindtap="switchTab" data-tab="schedule">æœ¬å‘¨è¯¾è¡¨</view>
  </view>

  <!-- è¯¾ç¨‹åˆ—è¡¨ -->
  <view class="tab-content" hidden="{{activeTab !== 'course'}}">
    <!-- æœç´¢å’Œæ·»åŠ è¯¾ç¨‹åŒä¸€è¡Œï¼Œä½¿ç”¨ç›´è§’è®¾è®¡ -->
  <view class="search-add-container">
    <view class="search-box">
      <input type="text" placeholder="æœç´¢è¯¾ç¨‹" bindinput="onSearch" value="{{searchKey}}" />
      <view class="search-icon">ğŸ”</view>
    </view>
    <button class="add-btn" bindtap="showAddCourse">æ·»åŠ </button>
  </view>

    <scroll-view class="course-list" scroll-y>
      <view wx:if="{{loading && courseList.length === 0}}" class="loading-tip">åŠ è½½ä¸­...</view>
      <view wx:elif="{{courseList.length === 0}}" class="empty-tip">æš‚æ— è¯¾ç¨‹</view>

      <view wx:for="{{courseList}}" wx:key="id" class="course-item">
        <view class="course-info" bindtap="showCourseDetail" data-id="{{item.id}}">
          <view class="course-header">
            <view class="course-name">{{item.name}}</view>
            <view class="course-status status-{{item.status}}">
              {{item.status === 'PUBLISHED' ? 'å·²å‘å¸ƒ' : (item.status === 'SUSPENDED' ? 'å·²æš‚åœ' : 'å·²ç»ˆæ­¢')}}
            </view>
          </view>
          <view class="course-detail">
            <text>{{item.type}}</text>
            <text class="dot"> Â· </text>
            <text>Â¥{{item.price}}</text>
            <text class="dot"> Â· </text>
            <text>æ€»è¯¾æ—¶{{item.totalHours || 0}}</text>
            <text class="dot"> Â· </text>
            <text>å·²é”€{{item.consumedHours || 0}}</text>
          </view>
          <view class="course-coaches">
            <text>æ•™ç»ƒï¼š</text>
            <text wx:for="{{item.coaches}}" wx:key="id" wx:for-item="coach">{{coach.name}}{{index < item.coaches.length - 1 ? 'ã€' : ''}}</text>
          </view>
          <view class="course-update-time">
            <text>æ›´æ–°æ—¶é—´ï¼š{{item.updateTime || item.createdTime}}</text>
          </view>
        </view>
        <view class="course-actions">
          <view class="action-btn edit" bindtap="editCourse" data-id="{{item.id}}">ç¼–è¾‘</view>
          <view class="action-btn delete" bindtap="deleteCourse" data-id="{{item.id}}">åˆ é™¤</view>
        </view>
      </view>

      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <view wx:if="{{loading && courseList.length > 0}}" class="loading-more">åŠ è½½ä¸­...</view>
      <view wx:elif="{{!hasMore && courseList.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </scroll-view>
  </view>

  <!-- æœ¬å‘¨è¯¾è¡¨ -->
  <view class="tab-content" hidden="{{activeTab !== 'schedule'}}">
    <!-- å‘¨é€‰æ‹©å™¨ -->
    <view class="week-selector">
      <view class="week-nav" bindtap="prevWeek">
        <text class="arrow">â†</text>
      </view>
      <view class="current-week">{{weekRange}}</view>
      <view class="week-nav" bindtap="nextWeek">
        <text class="arrow">â†’</text>
      </view>
    </view>

    <!-- è¯¾è¡¨ -->
    <scroll-view class="schedule-container" scroll-y>
      <view class="schedule-grid">
        <!-- æ—¶é—´åˆ— -->
        <view class="time-column">
          <view class="time-header"></view>
          <view wx:for="{{timeSlots}}" wx:key="index" class="time-slot">
            {{item}}
          </view>
        </view>

        <!-- æ¯å¤©çš„è¯¾ç¨‹ -->
        <view wx:for="{{weekDays}}" wx:key="day" wx:for-item="day" class="day-column">
          <view class="day-header">{{day.name}}</view>
          <view class="day-slots">
            <view wx:for="{{timeSlots}}" wx:key="index" class="time-slot">
              <view
                wx:for="{{day.courses}}"
                wx:key="id"
                wx:for-item="course"
                class="course-block {{course.timeSlot === item ? 'show' : ''}}"
                style="height: {{course.duration / 30 * 100}}rpx;"
                bindtap="showScheduleDetail"
                data-id="{{course.id}}"
              >
                <view class="course-name">{{course.name}}</view>
                <view class="course-teacher">{{course.teacherName}}</view>
                <view class="course-room">{{course.roomName}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘è¯¾ç¨‹å¼¹çª— -->
  <view class="modal {{showCourseModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideCourseModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{editingCourse ? 'ç¼–è¾‘è¯¾ç¨‹' : 'æ·»åŠ è¯¾ç¨‹'}}</text>
        <view class="modal-close" bindtap="hideCourseModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">è¯¾ç¨‹åç§°</text>
          <input type="text" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°" value="{{courseForm.name}}" bindinput="onCourseFormInput" data-field="name" />
        </view>
        <view class="form-item">
          <text class="label">è¯¾ç¨‹ç±»å‹</text>
          <picker mode="selector" range="{{courseTypes}}" range-key="constantValue" value="{{courseForm.typeIndex}}" bindchange="onTypeChange">
            <view class="picker">
              {{courseTypes[courseForm.typeIndex].constantValue || 'è¯·é€‰æ‹©è¯¾ç¨‹ç±»å‹'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">è¯¾ç¨‹çŠ¶æ€</text>
          <picker mode="selector" range="{{statusOptions}}" value="{{courseForm.statusIndex}}" bindchange="onStatusChange">
            <view class="picker">
              {{statusOptions[courseForm.statusIndex] || 'è¯·é€‰æ‹©è¯¾ç¨‹çŠ¶æ€'}}
            </view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">ä¸Šè¯¾æ•™ç»ƒ</text>
          <view class="coach-selector" bindtap="showCoachSelector">
            <view class="coach-content">
              <text wx:if="{{selectedCoaches.length === 0}}" class="placeholder">è¯·é€‰æ‹©ä¸Šè¯¾æ•™ç»ƒ</text>
              <view wx:else class="coach-list">
                <text wx:for="{{selectedCoaches}}" wx:key="id" class="coach-name">
                  {{item.name}}{{index < selectedCoaches.length - 1 ? ' ' : ''}}
                </text>
              </view>
            </view>
            <text class="arrow">â–¼</text>
          </view>
        </view>
        <view class="form-item">
          <text class="label">æ¯æ¬¡æ¶ˆè€—è¯¾æ—¶</text>
          <input type="digit" placeholder="é»˜è®¤å€¼ï¼š1.0" value="{{courseForm.unitHours}}" bindinput="onCourseFormInput" data-field="unitHours" />
        </view>
        <view class="form-item">
          <text class="label">è¯¾ç¨‹å•ä»·</text>
          <input type="digit" placeholder="é»˜è®¤å€¼ï¼š100ï¼Œå•ä½ï¼šå…ƒ" value="{{courseForm.price}}" bindinput="onCourseFormInput" data-field="price" />
        </view>
        <view class="form-item">
          <text class="label">æ•™ç»ƒè¯¾æ—¶è´¹</text>
          <input type="digit" placeholder="é»˜è®¤å€¼ï¼š50ï¼Œå•ä½ï¼šå…ƒ" value="{{courseForm.coachFee}}" bindinput="onCourseFormInput" data-field="coachFee" />
        </view>
        <view class="form-item">
          <text class="label">è¯¾ç¨‹æè¿°</text>
          <textarea placeholder="é€‰å¡«" value="{{courseForm.description}}" bindinput="onCourseFormInput" data-field="description" />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideCourseModal">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="saveCourse">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æ•™ç»ƒé€‰æ‹©å¼¹çª— -->
  <view class="modal {{showCoachSelector ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideCoachSelector"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>é€‰æ‹©æ•™ç»ƒ</text>
        <view class="modal-close" bindtap="hideCoachSelector">Ã—</view>
      </view>
      <view class="modal-body">
        <checkbox-group bindchange="onCoachChange">
          <view wx:for="{{coachList}}" wx:key="id" class="checkbox-item">
            <checkbox value="{{item.id}}" checked="{{item.checked}}"/>
            <text>{{item.name}}</text>
          </view>
        </checkbox-group>
      </view>
      <view class="modal-footer">
        <button class="btn cancel" bindtap="hideCoachSelector">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="hideCoachSelector">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- è¯¾ç¨‹è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showDetailModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="hideDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>è¯¾ç¨‹è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-item">
          <text class="label">è¯¾ç¨‹åç§°ï¼š</text>
          <text class="value">{{currentCourse.name}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è¯¾ç¨‹ç±»å‹ï¼š</text>
          <text class="value">{{currentCourse.type}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è¯¾ç¨‹çŠ¶æ€ï¼š</text>
          <text class="value">{{currentCourse.status === 'PUBLISHED' ? 'å·²å‘å¸ƒ' : (currentCourse.status === 'SUSPENDED' ? 'å·²æš‚åœ' : 'å·²ç»ˆæ­¢')}}</text>
        </view>
        <view class="detail-item">
          <text class="label">ä¸Šè¯¾æ•™ç»ƒï¼š</text>
          <text class="value">{{currentCourse.coachNames}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ¯æ¬¡æ¶ˆè€—è¯¾æ—¶ï¼š</text>
          <text class="value">{{currentCourse.unitHours}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è¯¾ç¨‹å•ä»·ï¼š</text>
          <text class="value">Â¥{{currentCourse.price}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ•™ç»ƒè¯¾æ—¶è´¹ï¼š</text>
          <text class="value">Â¥{{currentCourse.coachFee}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ€»è¯¾æ—¶ï¼š</text>
          <text class="value">{{currentCourse.totalHours}}</text>
        </view>
        <view class="detail-item">
          <text class="label">å·²æ¶ˆè€—è¯¾æ—¶ï¼š</text>
          <text class="value">{{currentCourse.consumedHours}}</text>
        </view>
        <view class="detail-item">
          <text class="label">åˆ›å»ºæ—¶é—´ï¼š</text>
          <text class="value">{{currentCourse.createdTime}}</text>
        </view>
        <view class="detail-item">
          <text class="label">æ›´æ–°æ—¶é—´ï¼š</text>
          <text class="value">{{currentCourse.updateTime}}</text>
        </view>
        <view class="detail-item">
          <text class="label">è¯¾ç¨‹æè¿°ï¼š</text>
          <text class="value">{{currentCourse.description || 'æ— '}}</text>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn confirm" bindtap="hideDetailModal">å…³é—­</button>
      </view>
    </view>
  </view>
</view>
